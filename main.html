<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Polley</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <style>
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="polley container py-3">
    <h3 class="question py-2">This is a question</h3>
    <div class="row options-group">

    </div>
    <div style="display: none" class="has-chosen">
      You have voted
    </div>
    <div class="result">

    </div>
  </div>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js" integrity="sha384-feJI7QwhOS+hwpX2zkaeJQjeiwlhOP+SdQDqhgvvo1DsjtiSQByFdThsxO669S2D"
    crossorigin="anonymous"></script> -->
  <script>
    let = API_ROOT = "http://localhost:4300/api"
    let pollId = "5acb3cc113103727cb8000e5"
    let token = "5aca0b91621c8a168fa62e17"
    let headers = { "authid": token, "Content-Type": "application/json" }
    let optionsGroup = document.querySelector(".options-group")
    let resultHTML = document.querySelector(".result")
    toggleElem(document.querySelector(".has-chosen"))
    toggleElem(document.querySelector(".result"))

    window.onload = fetchPoll()

    function fetchPoll(dis) {
      console.log("Fetching stuff...")
      fetch(`${API_ROOT}/polls/${pollId}`, { headers })
        .then(res => res.json())
        .then(poll => {
          insertPollIntoDom(poll)
          dis && displayPoll(poll)
        })
    }

    function insertPollIntoDom(poll) {
      optionsGroup.innerHTML = ""
      document.querySelector(".question").textContent = poll.question
      poll.options.forEach(option => {
        optionsGroup.innerHTML += `<div data-id="${option._id}" class="col-xs-12 col-md-6 p-2 shadow option">${option.option}</div>`
      })
      Array.from(document.querySelectorAll(".option")).forEach(opt => {
        opt.addEventListener("click", vote)
      })
    }

    function toggleElem(elem) {
      elem.classList.toggle("hidden")
    }

    function vote(e) {
      let option = e.target.dataset.id
      toggleElem(optionsGroup)
      toggleElem(document.querySelector(".has-chosen"))
      console.log("You chose", { option })
      fetch(`${API_ROOT}/polls/${pollId}/vote`, { method: "POST", body: JSON.stringify({ option: option }), headers })
        .then(res => res.json())
        .then(console.log)
      fetchPoll(true)
    }

    function displayPoll(poll) {
      allVotes = poll.options.reduce((ini, res) => ini + res.votes ,0)
      toggleElem(resultHTML)
      poll.options.forEach(option => {
        console.log("ojsdjkcjnmbvcnm")
        resultHTML.innerHTML += 
        `<div class="col-xs-12 col-md-6">
          <div class="progress my-3">
            <div class="progress-bar" style="width: ${(option.votes/allVotes)*100}%">${option.option}</div>
          </div>
        </div>`
      })
    }
  </script>
</body>

</html>