<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Polley</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <style>
    .hidden {
      display: none;
    }
    .question {
      margin: 30px auto;
    }
    .option {
      font-size: 15px;      
    }
    .progress {
      height: 40px;
    }
    .progress > * {
      line-height: 40px;
      font-size: 15px;
    }
  </style>
</head>

<body>
  <div class="polley container">
    <h2 class="question text-center">Loading Poll...</h2>
    <div class="row options-group">

    </div>
    <div style="display: none" class="has-chosen">
      You have voted
    </div>
    <div class="result">

    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script>
    let = API_ROOT = "http://localhost:4300/api"
    let pollId = "5acb3cc113103727cb8000e5"
    let token = "5aca0b91621c8a168fa62e17"
    let headers = { "authid": token, "Content-Type": "application/json" }
    let optionsGroup = document.querySelector(".options-group")
    let resultHTML = document.querySelector(".result")
    toggleElem(document.querySelector(".has-chosen"))
    toggleElem(document.querySelector(".result"))

    window.onload = fetchPoll()

    function fetchPoll(dis) {
      console.log("Fetching stuff...")
      fetch(`${API_ROOT}/polls/${pollId}`, { headers })
        .then(res => res.json())
        .then(poll => {
          insertPollIntoDom(poll)
          dis && displayPoll(poll)
        })
    }

    function insertPollIntoDom(poll) {
      optionsGroup.innerHTML = ""
      document.querySelector(".question").textContent = poll.question
      poll.options.forEach(option => {
        optionsGroup.innerHTML += `
        <div data-id="${option._id}" class="panel panel-default option">
          <div class="panel-body">
            ${option.option}
          </div>
        </div>
        `
      })
      Array.from(document.querySelectorAll(".option")).forEach(opt => {
        opt.addEventListener("click", vote)
      })
    }

    function toggleElem(elem) {
      elem.classList.toggle("hidden")
    }

    function vote(e) {
      let option = e.target.dataset.id
      toggleElem(optionsGroup)
      toggleElem(document.querySelector(".has-chosen"))
      console.log("You chose", { option })
      fetch(`${API_ROOT}/polls/${pollId}/vote`, { method: "POST", body: JSON.stringify({ option: option }), headers })
        .then(res => res.json())
        .then(console.log)
      fetchPoll(true)
    }

    function displayPoll(poll) {
      var allVotes = poll.options.reduce((ini, res) => ini + res.votes, 0)
      toggleElem(resultHTML)
      poll.options.forEach(option => {
        resultHTML.innerHTML +=
        `<div class="col-xs-12 col-md-6 option-result">
          <div class="progress">
            <div class="progress-bar  progress-bar-striped" style="width: ${(option.votes / allVotes) * 100}%">${option.option}</div>
            <div class="pull-right">${option.votes} Votes (${((option.votes / allVotes) * 100).toFixed(2)}) </div>
          </div>
        </div>`
      })
    }
  </script>
</body>

</html>